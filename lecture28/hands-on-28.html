

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Variational Inference Examples &#8212; Introduction to Scientific Machine Learning (Lecture Book)</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=ac02cc09edc035673794" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=ac02cc09edc035673794" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=ac02cc09edc035673794"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'lecture28/hands-on-28';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Homework" href="../homework/intro.html" />
    <link rel="prev" title="Variational Inference" href="reading-28.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    <p class="title logo__title">Introduction to Scientific Machine Learning (Lecture Book)</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../index.html">
                    Preface
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../introduction.html">Introduction</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../lecture01/intro.html">Lecture 1 - Introduction to Predictive Modeling</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../lecture01/reading-01.html">The Basics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture01/hands-on-01.1.html">The Uncertainty Propagation Problem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture01/hands-on-01.2.html">The Model Calibration Problem</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../review_probability.html">Review of Probability</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../lecture02/intro.html">Lecture 2 - Basics of Probability Theory</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../lecture02/reading-02.html">Basics of Probability Theory</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture02/hands-on-02.html">Experiment with “Randomness”</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../lecture03/intro.html">Lecture 3 - Discrete Random Variables</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../lecture03/reading-03.html">Discrete Random Variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture03/hands-on-03.html">Discrete Random Variables in Python</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../lecture04/intro.html">Lecture 4 - Continuous Random Variables</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../lecture04/reading-04.html">Continuous Random Variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture04/hands-on-04.1.html">The Uniform Distribution</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture04/hands-on-04.2.html">The Gaussian Distribution</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../lecture05/intro.html">Lecture 5 - Collections of Random Variables</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../lecture05/reading-05.html">Collections of Random Variables: Theory</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture05/hands-on-05.html">Practicing with Joint Probability Mass Functions</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../lecture06/intro.html">Lecture 6 - Random Vectors</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../lecture06/reading-06.html">Random Vectors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture06/hands-on-06.1.html">The Multivariate Normal - Diagonal Covariance Case</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture06/hands-on-06.2.html">The Multivariate Normal - Full Covariance Case</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture06/hands-on-06.3.html">The Multivariate Normal - Marginalization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture06/hands-on-06.4.html">The Multivariate Normal - Conditioning</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../uncertainty_propagation.html">Uncertainty Propagation</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../lecture07/intro.html">Lecture 7 - Basic Sampling</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-10"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../lecture07/hands-on-07.1.html">Pseudo-random number generators</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture07/hands-on-07.2.html">Sampling the uniform distribution</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture07/hands-on-07.3.html">Sampling the categorical</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture07/hands-on-07.4.html">Sampling from continuous distributions - Inverse sampling</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../lecture08/intro.html">Lecture 8 - The Monte Carlo Method for Estimating Expectations</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-11"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../lecture08/reading-08.html">The Uncertainty Propagation Problem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture08/hands-on-08.3.html">The Monte Carlo Method for Estimating Expectations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture08/hands-on-08.4.html">Sampling Estimates of Variance</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../lecture09/intro.html">Lecture 9 - Monte Carlo Estimates of Various Statistics</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-12"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../lecture09/hands-on-09.1.html">Sampling Estimates of the Cumulative Distribution Function</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture09/hands-on-09.2.html">Sampling Estimates of the Probability Density via Histograms</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture09/hands-on-09.3.html">Estimating Predictive Quantiles</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture09/hands-on-09.4.html">Uncertainty propagation through an ordinary differential equation</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../lecture10/intro.html">Lecture 10 - Quantify Uncertainty in Monte Carlo Estimates</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-13"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../lecture10/hands-on-10.1.html">Visualizing Monte Carlo Uncertainty</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture10/hands-on-10.2.html">The Central Limit Theorem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture10/hands-on-10.3.html">Quantifying Epistemic Uncertainty in Monte Carlo Estimates</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture10/hands-on-10.4.html">Uncertainty Propagation Through a Boundary Value Problem</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../principles_of_bi.html">Principles of Bayesian Inference</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-14"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../lecture11/intro.html">Lecture 11 - Selecting Prior Information</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-15"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../lecture11/reading-11.html">Selecting Prior Information</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture11/hands-on-11.1.html">Information Entropy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture11/hands-on-11.2.html">The Principle of Maximum Entropy for Discrete Random Variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture11/hands-on-11.3.html">The Principle of Maximum Entropy for Continuous Random Variables</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../lecture12/intro.html">Lecture 12 - Analytical Examples of Bayesian Inference</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-16"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../lecture12/reading-12.html">Bayesian inference</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture12/hands-on-12.1.html">Example: Inferring the probability of a coin toss from data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture12/hands-on-12.2.html">Credible Intervals</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture12/hands-on-12.3.html">Decision Making</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture12/hands-on-12.4.html">Posterior Predictive Checking</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../supervised_learning.html">Supervised Learning</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-17"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../lecture13/intro.html">Lecture 13 - Linear Regression via Least Squares</a><input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-18"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../lecture13/reading-13.html">Linear Regression via Least Squares</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture13/hands-on-13.1.html">Linear regression with a single variable</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture13/hands-on-13.2.html">Polynomial Regression</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture13/hands-on-13.3.html">The Generalized Linear Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture13/hands-on-13.4.html">Measures of Predictive Accuracy</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../lecture14/intro.html">Lecture 14 - Bayesian Linear Regression</a><input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-19"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../lecture14/reading-14.html">Bayesian Linear Regression</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture14/hands-on-14.1.html">Probabilistic Interpretation of Least Squares - Estimating the Measurement Noise</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture14/hands-on-14.2.html">Maximum a Posteriori Estimate - Avoiding Overfitting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture14/hands-on-14.3.html">Bayesian Linear Regression</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture14/hands-on-14.4.html">The point-predictive Distribution - Separating Epistemic and Aleatory Uncertainty</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../lecture15/intro.html">Lecture 15 - Advanced Topics in Bayesian Linear Regression</a><input class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-20"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../lecture15/reading-15.html">Advanced Topics in Bayesian Linear Regression</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture15/hands-on-15.1.html">Evidence approximation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture15/hands-on-15.2.html">Automatic Relevance Determination</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture15/hands-on-15.3.html">Diagnostics for Posterior Predictive</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../lecture16/intro.html">Lecture 16 - Classification</a><input class="toctree-checkbox" id="toctree-checkbox-21" name="toctree-checkbox-21" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-21"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../lecture16/reading-16.html">Theoretical Background on Classification</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture16/hands-on-16.1.html">Logistic regression with one variable (High melting explosives)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture16/hands-on-16.2.html">Logistic Regression with Many Features</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture16/hands-on-16.3.html">Decision making</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture16/hands-on-16.4.html">Diagnostics for Classifications</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture16/hands-on-16.5.html">Multi-class Logistic Regression</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../unsupervised_learning.html">Unsupervised Learning</a><input class="toctree-checkbox" id="toctree-checkbox-22" name="toctree-checkbox-22" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-22"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../lecture17/intro.html">Lecture 17 - Clustering and Density Estimation</a><input class="toctree-checkbox" id="toctree-checkbox-23" name="toctree-checkbox-23" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-23"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../lecture17/reading-17.html">Unsupervised Learning</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture17/hands-on-17.1.html">Clustering using k-means</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture17/hands-on-17.2.html">Density Estimation via Gaussian mixtures</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../lecture18/intro.html">Lecture 18 - Dimensionality Reduction</a><input class="toctree-checkbox" id="toctree-checkbox-24" name="toctree-checkbox-24" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-24"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../lecture18/reading-18.html">Dimensionality Reduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture18/hands-on-18.1.html">Dimensionality Reduction Examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture18/hands-on-18.2.html">Clustering High-dimensional Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture18/hands-on-18.3.html">Density Estimation with High-dimensional Data</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../state_space_models.html">State Space Models</a><input class="toctree-checkbox" id="toctree-checkbox-25" name="toctree-checkbox-25" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-25"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../lecture19/intro.html">Lecture 19 - State Space Models - Filtering Basics</a><input class="toctree-checkbox" id="toctree-checkbox-26" name="toctree-checkbox-26" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-26"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../lecture19/reading-19.html">State Space Models - Filtering Basics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture19/hands-on-19.1.html">Object Tracking Example</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../lecture20/intro.html">Lecture 20 - State Space Models - Kalman Filters</a><input class="toctree-checkbox" id="toctree-checkbox-27" name="toctree-checkbox-27" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-27"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../lecture20/reading-20.html">State Space Models - Kalman Filters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture20/hands-on-20.1.html">Kalman Filter for the Object Tracking Example</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../gaussian_process_regression.html">Gaussian Process Regression</a><input class="toctree-checkbox" id="toctree-checkbox-28" name="toctree-checkbox-28" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-28"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../lecture21/intro.html">Lecture 21 - Gaussian Process Regression: Priors on Function Spaces</a><input class="toctree-checkbox" id="toctree-checkbox-29" name="toctree-checkbox-29" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-29"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../lecture21/reading-21.html">Gaussian Process Theory</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture21/hands-on-21.html">Example: Priors on function spaces</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../lecture22/intro.html">Lecture 22 - Gaussian Process Regression: Conditioning on Data</a><input class="toctree-checkbox" id="toctree-checkbox-30" name="toctree-checkbox-30" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-30"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../lecture22/reading-22.html">Gaussian Process Regression - Theory</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture22/hands-on-22.1.html">Gaussian Process Regression Without Noise</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture22/hands-on-22.2.html">Gaussian Process Regression with Noise</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture22/hands-on-22.3.html">Tuning the Hyperparameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture22/hands-on-22.4.html">Multivariate Gaussian Process Regression</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../lecture23/intro.html">Lecture 23 - Bayesian Global Optimization</a><input class="toctree-checkbox" id="toctree-checkbox-31" name="toctree-checkbox-31" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-31"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../lecture23/reading-23.html">Bayesian Global Optimization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture23/hands-on-23.1.html">Maximum Mean - A Bad Information Acquisition Function</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture23/hands-on-23.2.html">Maximum Upper Interval</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture23/hands-on-23.3.html">Probability of Improvement</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture23/hands-on-23.4.html">Expected Improvement</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture23/hands-on-23.5.html">Expected Improvement - With Observation Noise</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture23/hands-on-23.6.html">Quantifying Epistemic Uncertainty about the Solution of the Optimization problem</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../neural_networks.html">Neural Networks</a><input class="toctree-checkbox" id="toctree-checkbox-32" name="toctree-checkbox-32" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-32"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../lecture24/intro.html">Lecture 24 - Deep Neural Networks</a><input class="toctree-checkbox" id="toctree-checkbox-33" name="toctree-checkbox-33" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-33"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../lecture24/reading-24.html">Deep Neural Networks</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture24/hands-on-24.html">Regression with Deep Neural Networks</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../lecture25/intro.html">Lecture 25 - Deep Neural Networks Continued</a><input class="toctree-checkbox" id="toctree-checkbox-34" name="toctree-checkbox-34" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-34"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../lecture25/reading-25.html">Deep Neural Networks Continued</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture25/hands-on-25.html">Classification with Deep Neural Networks</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../lecture26/intro.html">Lecture 26 - Physics-informed Deep Neural Networks</a><input class="toctree-checkbox" id="toctree-checkbox-35" name="toctree-checkbox-35" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-35"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../lecture26/reading-26.html">Physics-informed Deep Neural Networks</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture26/hands-on-26.1.html">Physics-informed regularization: Solving ODEs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture26/hands-on-26.2.html">Physics-informed regularization: Solving PDEs</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../advanced_methods.html">Advanced Methods for Characterizing Posteriors</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-36" name="toctree-checkbox-36" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-36"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2 has-children"><a class="reference internal" href="../lecture27/intro.html">Lecture 27 - Sampling Methods</a><input class="toctree-checkbox" id="toctree-checkbox-37" name="toctree-checkbox-37" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-37"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../lecture27/reading-27.html">Sampling Methods</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture27/hands-on-27.1.html">Probabilistic numerics using <code class="docutils literal notranslate"><span class="pre">pyro</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture27/hands-on-27.2.html">Sampling From the Distributions With Random Walk Metropolis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture27/hands-on-27.3.html">The Metropolis-Hastings Algorithm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lecture27/hands-on-27.4.html">Hierarchical Bayesian Models</a></li>
</ul>
</li>
<li class="toctree-l2 current active has-children"><a class="reference internal" href="intro.html">Lecture 28 - Variational Inference</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-38" name="toctree-checkbox-38" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-38"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="reading-28.html">Variational Inference</a></li>
<li class="toctree-l3 current active"><a class="current reference internal" href="#">Variational Inference Examples</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../homework/intro.html">Homework</a><input class="toctree-checkbox" id="toctree-checkbox-39" name="toctree-checkbox-39" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-39"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../homework/homework-01.html">Homework 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../homework/homework-02.html">Homework 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../homework/homework-03.html">Homework 3</a></li>
<li class="toctree-l2"><a class="reference internal" href="../homework/homework-04.html">Homework 4</a></li>



<li class="toctree-l2"><a class="reference internal" href="../homework/homework-05.html">Homework 5</a></li>



<li class="toctree-l2"><a class="reference internal" href="../homework/homework-06.html">Homework 6</a></li>
<li class="toctree-l2"><a class="reference internal" href="../homework/homework-07a.html">Homework 7 - Part A</a></li>
<li class="toctree-l2"><a class="reference internal" href="../homework/homework-07b.html">Homework 7 - Part B</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../bibliography.html">Bibliography</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/PredictiveScienceLab/data-analytics-se/blob/master/lecturebook/lecture28/hands-on-28.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/lecture28/hands-on-28.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Variational Inference Examples</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-1-normal-normal-model">Example 1 - normal-normal model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-2-coin-toss-example">Example 2 - Coin-toss example</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-3-challenger-space-shuttle-disaster">Example 3 - Challenger Space Shuttle Disaster</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#probabilistic-model">Probabilistic model</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">matplotlib_inline</span>
<span class="n">matplotlib_inline</span><span class="o">.</span><span class="n">backend_inline</span><span class="o">.</span><span class="n">set_matplotlib_formats</span><span class="p">(</span><span class="s1">&#39;svg&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="s2">&quot;paper&quot;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s2">&quot;ticks&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">st</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">download</span><span class="p">(</span>
    <span class="n">url</span> <span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">local_filename</span> <span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Download a file from a url.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    url            -- The url we want to download.</span>
<span class="sd">    local_filename -- The filemame to write on. If not</span>
<span class="sd">                      specified </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">local_filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">local_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">local_filename</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
</div>
<section class="tex2jax_ignore mathjax_ignore" id="variational-inference-examples">
<h1>Variational Inference Examples<a class="headerlink" href="#variational-inference-examples" title="Permalink to this heading">#</a></h1>
<p>We introduce variational inference (VI) for approximate Bayesian Inference.
We implement VI from scratch in <code class="docutils literal notranslate"><span class="pre">pytorch</span></code> and we also show how to do it in <code class="docutils literal notranslate"><span class="pre">pyro</span></code>.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://arxiv.org/pdf/1601.00670.pdf">Variational Inference: A Review for Statisticians (Blei et al, 2018)</a>.</p></li>
<li><p><a class="reference external" href="https://arxiv.org/pdf/1603.00788.pdf">Automatic Differentiation Variational Inference (Kucukelbir et al, 2016)</a>.</p></li>
<li><p><a class="reference external" href="https://arxiv.org/pdf/1312.6114.pdf">Autoencoding Variational Bayes (Kingma and Welling, 2014)</a>.</p></li>
<li><p><a class="reference external" href="https://arxiv.org/pdf/1401.0118.pdf">Black Box Variational Inference (Ranganath et al, 2013)</a>.</p></li>
<li><p><a class="reference external" href="https://arxiv.org/pdf/1608.04471.pdf">Stein Variational Gradient Descent (Liu and Wang, 2016)</a>.</p></li>
<li><p><a class="reference external" href="https://arxiv.org/pdf/1505.05770.pdf">Variational Inference with Normalizing Flows (Rezende and Mohamed, 2016)</a>.</p></li>
</ul>
<p><strong>Note:</strong> This notebook was originally developed by <a class="reference external" href="https://rohittripathy.netlify.com">Dr. Rohit Tripathy</a> in <code class="docutils literal notranslate"><span class="pre">PyMC</span></code>. It was modified by <span class="xref myst">Prof. Bilionis</span> using <code class="docutils literal notranslate"><span class="pre">pytorch</span></code> and <code class="docutils literal notranslate"><span class="pre">pyro</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Do this in Google Colab</span>
<span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>pyro-ppl
</pre></div>
</div>
</div>
</div>
<section id="example-1-normal-normal-model">
<h2>Example 1 - normal-normal model<a class="headerlink" href="#example-1-normal-normal-model" title="Permalink to this heading">#</a></h2>
<p>Let’s demonstrate the VI process end-to-end with a simple example.
Consider the task of inferring the gravitational constant from data.
We perform experiments <span class="math notranslate nohighlight">\(x_{1:n}\)</span> which measure the acceleration of gravity, and we know that the measurement standard deviation is <span class="math notranslate nohighlight">\(\sigma = 0.1\)</span>.
Here are some synthetic data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">scipy.constants</span>
<span class="n">g_true</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">g</span>

<span class="c1"># Generate some synthetic data</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">g_true</span> <span class="o">+</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">g_true</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True value&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c1a962e299eb3f6768b997599b810086a51807a8a216c3c7fb8eb9beefebdb4e.svg" src="../_images/c1a962e299eb3f6768b997599b810086a51807a8a216c3c7fb8eb9beefebdb4e.svg" /></div>
</div>
<p>The likelihood of each measurement is given by:</p>
<div class="math notranslate nohighlight">
\[
x_i | g, \sigma \sim N(g, \sigma^2).
\]</div>
<p>So, the model says that the measured acceleration of gravity is around the true one with some Gaussian noise.
Assume that our prior state-of-knowledge over <span class="math notranslate nohighlight">\(g\)</span> is:</p>
<div class="math notranslate nohighlight">
\[
g | g_0, s_0 \sim N(g_0, s_0^2),
\]</div>
<p>with known <span class="math notranslate nohighlight">\(g_0 = 10\)</span>, <span class="math notranslate nohighlight">\(s_0 = 0.4\)</span>.
This is a, so-called, <a class="reference external" href="https://en.wikipedia.org/wiki/Conjugate_prior">conjugate prior</a> and the posterior over <span class="math notranslate nohighlight">\(g\)</span> is given analytically by:</p>
<div class="math notranslate nohighlight">
\[
g|x_{1:n} \sim N(\tilde{g}, \tilde{s}^2),
\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[
\tilde{s}^2 = \left( \frac{n}{\sigma^2} + \frac{1}{s_0^2} \right)^{-1},
\]</div>
<p>and</p>
<div class="math notranslate nohighlight">
\[
\tilde{g} = \tilde{s}^2 \left( \frac{g_0}{s_0^2} + \frac{\sum_{i=1}^{n} x_i}{\sigma^2}\right).
\]</div>
<p>Let’s write some code to get this analytical posterior:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">post_mean_and_variance</span><span class="p">(</span><span class="n">prior_mean</span><span class="p">,</span> <span class="n">prior_variance</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">likelihood_var</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">sigma2</span> <span class="o">=</span> <span class="n">likelihood_var</span>
    <span class="n">s02</span> <span class="o">=</span> <span class="n">prior_variance</span>
    <span class="n">m0</span> <span class="o">=</span> <span class="n">prior_mean</span>
    <span class="n">sumdata</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">post_prec</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="n">sigma2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">s02</span><span class="p">)</span>
    <span class="n">post_var</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">post_prec</span>
    <span class="n">post_mean</span> <span class="o">=</span> <span class="n">post_var</span> <span class="o">*</span> <span class="p">((</span><span class="n">m0</span><span class="o">/</span><span class="n">s02</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">sumdata</span><span class="o">/</span><span class="n">sigma2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">post_mean</span><span class="p">,</span> <span class="n">post_var</span>

<span class="n">gtilde</span><span class="p">,</span> <span class="n">s2tilde</span> <span class="o">=</span> <span class="n">post_mean_and_variance</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">0.4</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mf">0.1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="n">xs1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">xs2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs1</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">xs1</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prior&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs2</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">gtilde</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s2tilde</span><span class="p">))</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">xs2</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Posterior&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">g_true</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True value&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ff98a30cd53edb4e47f44a361d3d07320faa38ca175db8bc6a6497707f9a662f.svg" src="../_images/ff98a30cd53edb4e47f44a361d3d07320faa38ca175db8bc6a6497707f9a662f.svg" /></div>
</div>
<p>Now let’s try to infer the posterior over <span class="math notranslate nohighlight">\(g\)</span> using VI. We specify the joint log probability of the model first.
We do everything using <code class="docutils literal notranslate"><span class="pre">pytorch</span></code> so that we can use automatic differentiation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">g0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">10.</span><span class="p">)</span>
<span class="n">s0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">logprior</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">g0</span><span class="p">,</span> <span class="n">s0</span><span class="p">)</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">loglikelihood</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">logjoint</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">logprior</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="o">+</span> <span class="n">loglikelihood</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We must specify a parameterized approximate posterior, <span class="math notranslate nohighlight">\(q_{\phi}(\cdot)\)</span>. The obvious choice here is a Gaussian:</p>
<div class="math notranslate nohighlight">
\[
q_{\phi}(g) = N(g | \phi_1, \exp(\phi_2)^2),
\]</div>
<p>where, <span class="math notranslate nohighlight">\(\phi = (\phi_1, \phi_2)\)</span> are the variational parameters. The ELBO needs to be maximized with respect to <span class="math notranslate nohighlight">\(\phi\)</span>. Let’s go ahead and set up the ELBO. Recall that the ELBO is given by:</p>
<div class="math notranslate nohighlight">
\[
\text{ELBO}(\phi) =  \mathbb{E}_{q(\theta)}[\log p(\theta, \mathcal{D})] + \mathbb{H}[q(\theta)].
\]</div>
<p>The entropy is given by:</p>
<div class="math notranslate nohighlight">
\[
\mathbb{H}[q(\theta)] = 1/2\log(2\pi \exp(\phi_2)^2) + 1/2 = \phi_2 + \text{const}.
\]</div>
<p>To optimize the ELBO, we must compute an expectation over the variational distribution <span class="math notranslate nohighlight">\(q\)</span> (first term on the RHS in the above equation). This cannot be done analytically. Instead, we resort to a Monte Carlo approximation:</p>
<div class="math notranslate nohighlight">
\[
\mathbb{E}_q [\log p(\theta, \mathbf{x})] \approx \frac{1}{S}\sum_{s=1}^{S}   \log p(\theta^{(s)}, \mathbf{x}),
\]</div>
<p>where the samples <span class="math notranslate nohighlight">\(\theta^{(s)}\)</span> are drawn from <span class="math notranslate nohighlight">\(q\)</span>.</p>
<p>Here is the code for the ELBO:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ELBO</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">):</span>
    <span class="n">g_samples</span> <span class="o">=</span> <span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">num_samples</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">logjoint</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">g_samples</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">+</span> <span class="n">phi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">negELBO</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">):</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">ELBO</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can setup the optimization problem.
Here we go:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">optim</span>

<span class="n">num_samples</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">num_iter</span> <span class="o">=</span> <span class="mi">20_000</span>
<span class="n">phi</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">9.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">])</span>
<span class="n">phi</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">([</span><span class="n">phi</span><span class="p">],</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>

<span class="n">elbos</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_iter</span><span class="p">):</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">negELBO</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">)</span>
    <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">1_000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iteration: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> Loss: </span><span class="si">{</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">elbos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
<span class="n">phi</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">False</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 0 Loss: 375.7824401855469
Iteration: 1000 Loss: 26.652555465698242
Iteration: 2000 Loss: 2.5472326278686523
Iteration: 3000 Loss: -1.334648847579956
Iteration: 4000 Loss: 0.9369990825653076
Iteration: 5000 Loss: -7.821878433227539
Iteration: 6000 Loss: -0.5406231880187988
Iteration: 7000 Loss: -6.518988609313965
Iteration: 8000 Loss: -5.652396202087402
Iteration: 9000 Loss: -5.485063076019287
Iteration: 10000 Loss: -5.161447525024414
Iteration: 11000 Loss: -7.376476287841797
Iteration: 12000 Loss: -5.037634372711182
Iteration: 13000 Loss: -3.8640382289886475
Iteration: 14000 Loss: -3.771669626235962
Iteration: 15000 Loss: -4.731598854064941
Iteration: 16000 Loss: -5.233105182647705
Iteration: 17000 Loss: -5.517479419708252
Iteration: 18000 Loss: -5.228094100952148
Iteration: 19000 Loss: -6.046360015869141
</pre></div>
</div>
</div>
</div>
<p>Here is the evolution of the ELBO:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_iter</span><span class="p">),</span> <span class="n">elbos</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Iteration&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;ELBO&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5db6c7043c088b948dc10e12366cd321b6405e8879c423a7ebecc2fb35925fd0.svg" src="../_images/5db6c7043c088b948dc10e12366cd321b6405e8879c423a7ebecc2fb35925fd0.svg" /></div>
</div>
<p>Let’s build and visualize the approximate posterior:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">postmean</span> <span class="o">=</span> <span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">poststdev</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">gpost</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">postmean</span><span class="p">,</span> <span class="n">poststdev</span><span class="p">)</span>

<span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">9.6</span><span class="p">,</span> <span class="mf">10.1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">gtilde</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s2tilde</span><span class="p">))</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True Posterior&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">gpost</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;VI Posterior&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">g_true</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True value&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/9ba16c1bfbf1a0f6bae363f0be4d605b6d9032adb851aeddffd23f9f76106ac4.svg" src="../_images/9ba16c1bfbf1a0f6bae363f0be4d605b6d9032adb851aeddffd23f9f76106ac4.svg" /></div>
</div>
<p>As you can see, our approximation of the posterior is close. The normal-normal model is a straightforward example with one latent variable. In practice, setting up the variational posterior for all latent variables, keeping track of transformations, and optimizing the variational parameters can become tedious for models of any reasonable level of complexity.</p>
<p>Now let’s do the same thing using <code class="docutils literal notranslate"><span class="pre">pyro</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pyro</span>
<span class="kn">import</span> <span class="nn">pyro.distributions</span> <span class="k">as</span> <span class="nn">dist</span>


<span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">pyro</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">g0</span><span class="p">,</span> <span class="n">s0</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">pyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">pyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;obs&quot;</span><span class="p">,</span> <span class="n">pyro</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We need to define the guide. We can either do it by hand or use the <code class="docutils literal notranslate"><span class="pre">AutoNormal</span></code> guide.
The <code class="docutils literal notranslate"><span class="pre">AutoNormal</span></code> scans the model for laten variables (in our model the only such variable is <code class="docutils literal notranslate"><span class="pre">g</span></code>) and it constructs a guide that is a normal distribution with learnable parameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">guide</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">autoguide</span><span class="o">.</span><span class="n">AutoNormal</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Then we can do inference:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># This removes old parameters from the parameter store.</span>
<span class="c1"># If you don&#39;t do this, you&#39;ll overwrite parameters from</span>
<span class="c1"># previous runs.</span>
<span class="n">pyro</span><span class="o">.</span><span class="n">clear_param_store</span><span class="p">()</span>

<span class="c1"># This is the stochastic variational inference algorithm:</span>
<span class="n">svi</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">SVI</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span>              <span class="c1"># model to optimize</span>
    <span class="n">guide</span><span class="p">,</span>              <span class="c1"># variational distribution</span>
    <span class="n">pyro</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span>    <span class="c1"># optimizer to use</span>
        <span class="p">{</span><span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">}</span>   <span class="c1"># parameters of the optimizer</span>
    <span class="p">),</span>
    <span class="n">pyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">JitTrace_ELBO</span><span class="p">()</span> <span class="c1"># loss optimization function - here, the ELBO</span>
<span class="p">)</span>

<span class="c1"># And we can iterate:</span>
<span class="n">num_iter</span> <span class="o">=</span> <span class="mi">20_000</span>
<span class="n">elbos</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_iter</span><span class="p">):</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">svi</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">elbos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">loss</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">1_000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iteration: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> Loss: </span><span class="si">{</span><span class="n">loss</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 0 Loss: 49686.4765625
Iteration: 1000 Loss: 40596.5390625
Iteration: 2000 Loss: 30614.01953125
Iteration: 3000 Loss: 24874.3671875
Iteration: 4000 Loss: 19644.50390625
Iteration: 5000 Loss: 12995.2060546875
Iteration: 6000 Loss: 9540.4306640625
Iteration: 7000 Loss: 6226.10107421875
Iteration: 8000 Loss: 3715.46435546875
Iteration: 9000 Loss: 2070.754150390625
Iteration: 10000 Loss: 1292.1932373046875
Iteration: 11000 Loss: 252.4281463623047
Iteration: 12000 Loss: 38.22501754760742
Iteration: 13000 Loss: -5.493821620941162
Iteration: 14000 Loss: -2.04667329788208
Iteration: 15000 Loss: -7.136266708374023
Iteration: 16000 Loss: -5.793765544891357
Iteration: 17000 Loss: -7.158337116241455
Iteration: 18000 Loss: -7.028347015380859
Iteration: 19000 Loss: -6.882040023803711
</pre></div>
</div>
</div>
</div>
<p>Let’s put the training loop in a function for later use:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">guide</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">num_iter</span><span class="o">=</span><span class="mi">5_000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Train a model with a guide.</span>

<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    model    -- The model to train.</span>
<span class="sd">    guide    -- The guide to train.</span>
<span class="sd">    data     -- The data to train the model with.</span>
<span class="sd">    num_iter -- The number of iterations to train.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    elbos -- The ELBOs for each iteration.</span>
<span class="sd">    param_store -- The parameters of the model.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pyro</span><span class="o">.</span><span class="n">clear_param_store</span><span class="p">()</span>

    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">({</span><span class="s2">&quot;lr&quot;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">})</span>

    <span class="n">svi</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">SVI</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">guide</span><span class="p">,</span>
        <span class="n">optimizer</span><span class="p">,</span>
        <span class="n">loss</span><span class="o">=</span><span class="n">pyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">JitTrace_ELBO</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="n">elbos</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_iter</span><span class="p">):</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">svi</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">)</span>
        <span class="n">elbos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">loss</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Iteration: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> Loss: </span><span class="si">{</span><span class="n">loss</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">elbos</span><span class="p">,</span> <span class="n">pyro</span><span class="o">.</span><span class="n">get_param_store</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s plot the ELBO:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_iter</span><span class="p">),</span> <span class="n">elbos</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Iteration&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;ELBO&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/7aa14cddac6c9151b57a61d68b647c35383790065cb1c27423670fa3881cce2a.svg" src="../_images/7aa14cddac6c9151b57a61d68b647c35383790065cb1c27423670fa3881cce2a.svg" /></div>
</div>
<p>Here is how you can extract information from the posterior:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">guide</span><span class="o">.</span><span class="n">median</span><span class="p">()</span> <span class="c1"># Only works for AutoGuide</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;g&#39;: tensor(9.7988)}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">guide</span><span class="o">.</span><span class="n">quantiles</span><span class="p">([</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">])</span> <span class="c1"># Only works for AutoGuide</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;g&#39;: tensor([9.7757, 9.8218])}
</pre></div>
</div>
</div>
</div>
<p>The other thing that you can do is use <code class="docutils literal notranslate"><span class="pre">pyro.infer.Predictive</span></code> to get samples from the guide:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">guide_g_samples</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Predictive</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">guide</span><span class="o">=</span><span class="n">guide</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1_000</span><span class="p">)(</span><span class="n">data</span><span class="p">)[</span><span class="s2">&quot;g&quot;</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="c1"># You have to detach the tensor from the computational graph</span>
<span class="c1"># otherwise it doesn&#39;t work.</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">guide_g_samples</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;VI Posterior&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">gpost</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True Posterior&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">g_true</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True value&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/9f44bde354b4d838117863b20730649f5262d6c9e2ca476e173f75e9bb847735.svg" src="../_images/9f44bde354b4d838117863b20730649f5262d6c9e2ca476e173f75e9bb847735.svg" /></div>
</div>
<p>The above code works with every guide, even hand-written ones.</p>
<p>Let’s repeat the above example using our own guide.
The results will be identical because <code class="docutils literal notranslate"><span class="pre">AutoNormal</span></code> is just a normal distribution with learnable parameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">guide</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">9.0</span><span class="p">))</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">2.0</span><span class="p">),</span>
                       <span class="n">constraint</span><span class="o">=</span><span class="n">dist</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">positive</span><span class="p">)</span>
    <span class="n">pyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">pyro</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>That’s it. Now, whenever <code class="docutils literal notranslate"><span class="pre">pyro</span></code> sees a <code class="docutils literal notranslate"><span class="pre">pyro.param</span></code> it understands that it needs to optimize it.
Let’s test i:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">elbos</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">guide</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">,),</span> <span class="n">num_iter</span><span class="o">=</span><span class="mi">20_000</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/5y/28n32xmx0551k29hd21qs87c0000gp/T/ipykernel_58779/2942119673.py:2: TracerWarning: torch.tensor results are registered as constants in the trace. You can safely ignore this warning if you use this function to create tensors out of constant variables that would be the same every time you call this function. In any other case, this might cause the trace to be incorrect.
  mu = pyro.param(&quot;mu&quot;, torch.tensor(9.0))
/var/folders/5y/28n32xmx0551k29hd21qs87c0000gp/T/ipykernel_58779/2942119673.py:3: TracerWarning: torch.tensor results are registered as constants in the trace. You can safely ignore this warning if you use this function to create tensors out of constant variables that would be the same every time you call this function. In any other case, this might cause the trace to be incorrect.
  sigma = pyro.param(&quot;sigma&quot;, torch.tensor(2.0),
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 0 Loss: 6863.5166015625
Iteration: 100 Loss: 4726.62841796875
Iteration: 200 Loss: 6681.0615234375
Iteration: 300 Loss: 1037.7930908203125
Iteration: 400 Loss: 5512.32958984375
Iteration: 500 Loss: 1687.9530029296875
Iteration: 600 Loss: 5955.34765625
Iteration: 700 Loss: 318.48486328125
Iteration: 800 Loss: -0.43179094791412354
Iteration: 900 Loss: 1379.1673583984375
Iteration: 1000 Loss: 1462.825927734375
Iteration: 1100 Loss: 62.86969757080078
Iteration: 1200 Loss: 1187.942138671875
Iteration: 1300 Loss: -10.333321571350098
Iteration: 1400 Loss: 1810.6552734375
Iteration: 1500 Loss: 17.4462890625
Iteration: 1600 Loss: 1257.30078125
Iteration: 1700 Loss: 7.44822883605957
Iteration: 1800 Loss: 1563.3077392578125
Iteration: 1900 Loss: 198.15220642089844
Iteration: 2000 Loss: 833.2096557617188
Iteration: 2100 Loss: 280.9329833984375
Iteration: 2200 Loss: -1.0198445320129395
Iteration: 2300 Loss: 342.187744140625
Iteration: 2400 Loss: 11.269716262817383
Iteration: 2500 Loss: -8.514278411865234
Iteration: 2600 Loss: 512.078369140625
Iteration: 2700 Loss: 542.8423461914062
Iteration: 2800 Loss: 32.65810012817383
Iteration: 2900 Loss: 20.113100051879883
Iteration: 3000 Loss: 723.205322265625
Iteration: 3100 Loss: 9.511959075927734
Iteration: 3200 Loss: 399.13018798828125
Iteration: 3300 Loss: -0.7385709285736084
Iteration: 3400 Loss: 582.1942138671875
Iteration: 3500 Loss: 129.11476135253906
Iteration: 3600 Loss: 133.29835510253906
Iteration: 3700 Loss: 161.52444458007812
Iteration: 3800 Loss: 13.85338020324707
Iteration: 3900 Loss: 275.53204345703125
Iteration: 4000 Loss: 37.831024169921875
Iteration: 4100 Loss: 420.3694763183594
Iteration: 4200 Loss: 618.74365234375
Iteration: 4300 Loss: -8.76242733001709
Iteration: 4400 Loss: -2.659954786300659
Iteration: 4500 Loss: 125.52645111083984
Iteration: 4600 Loss: 9.65471076965332
Iteration: 4700 Loss: 24.79283905029297
Iteration: 4800 Loss: -6.347537994384766
Iteration: 4900 Loss: 26.814159393310547
Iteration: 5000 Loss: 150.06910705566406
Iteration: 5100 Loss: 231.2753448486328
Iteration: 5200 Loss: 186.62539672851562
Iteration: 5300 Loss: 2.983067274093628
Iteration: 5400 Loss: -6.850186347961426
Iteration: 5500 Loss: 53.442626953125
Iteration: 5600 Loss: 35.3376579284668
Iteration: 5700 Loss: 22.088422775268555
Iteration: 5800 Loss: 4.767504692077637
Iteration: 5900 Loss: 43.433319091796875
Iteration: 6000 Loss: -8.174591064453125
Iteration: 6100 Loss: 15.100848197937012
Iteration: 6200 Loss: -5.886928558349609
Iteration: 6300 Loss: 2.2705323696136475
Iteration: 6400 Loss: 0.807808518409729
Iteration: 6500 Loss: 16.042556762695312
Iteration: 6600 Loss: 160.491455078125
Iteration: 6700 Loss: 88.98486328125
Iteration: 6800 Loss: 16.722379684448242
Iteration: 6900 Loss: -7.700603485107422
Iteration: 7000 Loss: -7.422141075134277
Iteration: 7100 Loss: 20.69399642944336
Iteration: 7200 Loss: 12.6574068069458
Iteration: 7300 Loss: 75.57760620117188
Iteration: 7400 Loss: -8.795297622680664
Iteration: 7500 Loss: 2.135460376739502
Iteration: 7600 Loss: 15.581229209899902
Iteration: 7700 Loss: 34.729217529296875
Iteration: 7800 Loss: 5.033120632171631
Iteration: 7900 Loss: 64.08548736572266
Iteration: 8000 Loss: -8.337617874145508
Iteration: 8100 Loss: -6.07992696762085
Iteration: 8200 Loss: 0.6487371921539307
Iteration: 8300 Loss: -8.175068855285645
Iteration: 8400 Loss: -0.6840838193893433
Iteration: 8500 Loss: -0.5311352014541626
Iteration: 8600 Loss: 7.673257350921631
Iteration: 8700 Loss: -7.948726654052734
Iteration: 8800 Loss: 39.045772552490234
Iteration: 8900 Loss: -5.875088214874268
Iteration: 9000 Loss: -6.13936710357666
Iteration: 9100 Loss: -5.38765287399292
Iteration: 9200 Loss: -3.403750419616699
Iteration: 9300 Loss: -7.115334510803223
Iteration: 9400 Loss: -3.978450298309326
Iteration: 9500 Loss: -8.129117965698242
Iteration: 9600 Loss: -8.257028579711914
Iteration: 9700 Loss: -8.088420867919922
Iteration: 9800 Loss: -8.254077911376953
Iteration: 9900 Loss: -5.425186634063721
Iteration: 10000 Loss: 0.27979975938796997
Iteration: 10100 Loss: -3.1878466606140137
Iteration: 10200 Loss: -0.5475963354110718
Iteration: 10300 Loss: -6.924840927124023
Iteration: 10400 Loss: -8.02815055847168
Iteration: 10500 Loss: -1.2006770372390747
Iteration: 10600 Loss: -5.848913669586182
Iteration: 10700 Loss: -2.4069879055023193
Iteration: 10800 Loss: -6.6708269119262695
Iteration: 10900 Loss: -6.061272621154785
Iteration: 11000 Loss: -6.134784698486328
Iteration: 11100 Loss: -2.4381508827209473
Iteration: 11200 Loss: -0.30546820163726807
Iteration: 11300 Loss: 11.974300384521484
Iteration: 11400 Loss: -7.944908618927002
Iteration: 11500 Loss: -0.7399576902389526
Iteration: 11600 Loss: -1.2389609813690186
Iteration: 11700 Loss: 25.194276809692383
Iteration: 11800 Loss: -7.398594379425049
Iteration: 11900 Loss: -7.51558780670166
Iteration: 12000 Loss: -7.035286903381348
Iteration: 12100 Loss: -7.560616493225098
Iteration: 12200 Loss: -7.617308616638184
Iteration: 12300 Loss: -7.54684591293335
Iteration: 12400 Loss: -4.699420928955078
Iteration: 12500 Loss: -2.934391498565674
Iteration: 12600 Loss: -4.508200645446777
Iteration: 12700 Loss: 1.2815603017807007
Iteration: 12800 Loss: -6.792910099029541
Iteration: 12900 Loss: -7.661536693572998
Iteration: 13000 Loss: -7.5992207527160645
Iteration: 13100 Loss: -5.169339179992676
Iteration: 13200 Loss: -7.44121789932251
Iteration: 13300 Loss: 1.4796619415283203
Iteration: 13400 Loss: -7.568403244018555
Iteration: 13500 Loss: -4.503005027770996
Iteration: 13600 Loss: -7.495359897613525
Iteration: 13700 Loss: -7.481572151184082
Iteration: 13800 Loss: -6.9588398933410645
Iteration: 13900 Loss: -1.478920817375183
Iteration: 14000 Loss: -4.450002193450928
Iteration: 14100 Loss: -4.372940540313721
Iteration: 14200 Loss: -7.3279242515563965
Iteration: 14300 Loss: -6.8539018630981445
Iteration: 14400 Loss: -6.539721965789795
Iteration: 14500 Loss: -7.326222896575928
Iteration: 14600 Loss: -5.344386577606201
Iteration: 14700 Loss: -6.607089519500732
Iteration: 14800 Loss: -7.293154239654541
Iteration: 14900 Loss: -7.291573524475098
Iteration: 15000 Loss: -6.9718499183654785
Iteration: 15100 Loss: -7.021787643432617
Iteration: 15200 Loss: -7.099093437194824
Iteration: 15300 Loss: -4.358132362365723
Iteration: 15400 Loss: -5.313650608062744
Iteration: 15500 Loss: -6.455587863922119
Iteration: 15600 Loss: -6.4632182121276855
Iteration: 15700 Loss: -5.837204456329346
Iteration: 15800 Loss: -7.031949520111084
Iteration: 15900 Loss: -7.05983304977417
Iteration: 16000 Loss: -6.796117305755615
Iteration: 16100 Loss: -6.874577045440674
Iteration: 16200 Loss: -6.93787956237793
Iteration: 16300 Loss: -6.6703972816467285
Iteration: 16400 Loss: -6.997195243835449
Iteration: 16500 Loss: -7.0669331550598145
Iteration: 16600 Loss: -6.786100387573242
Iteration: 16700 Loss: -5.548006534576416
Iteration: 16800 Loss: -7.049220561981201
Iteration: 16900 Loss: -6.343357086181641
Iteration: 17000 Loss: -7.048659324645996
Iteration: 17100 Loss: -6.335675239562988
Iteration: 17200 Loss: -6.211577892303467
Iteration: 17300 Loss: -6.943521022796631
Iteration: 17400 Loss: -6.881516933441162
Iteration: 17500 Loss: -6.718965530395508
Iteration: 17600 Loss: -6.93778133392334
Iteration: 17700 Loss: -6.441198825836182
Iteration: 17800 Loss: -6.462118148803711
Iteration: 17900 Loss: -6.886161804199219
Iteration: 18000 Loss: -6.8985772132873535
Iteration: 18100 Loss: -6.964326858520508
Iteration: 18200 Loss: -6.686488628387451
Iteration: 18300 Loss: -6.87588357925415
Iteration: 18400 Loss: -6.595379829406738
Iteration: 18500 Loss: -6.88122034072876
Iteration: 18600 Loss: -6.807351112365723
Iteration: 18700 Loss: -6.926386833190918
Iteration: 18800 Loss: -6.8103742599487305
Iteration: 18900 Loss: -6.609341621398926
Iteration: 19000 Loss: -6.961921691894531
Iteration: 19100 Loss: -6.779007911682129
Iteration: 19200 Loss: -6.730861186981201
Iteration: 19300 Loss: -6.651981830596924
Iteration: 19400 Loss: -6.811529636383057
Iteration: 19500 Loss: -6.911961555480957
Iteration: 19600 Loss: -6.773965835571289
Iteration: 19700 Loss: -6.892739772796631
Iteration: 19800 Loss: -6.684868812561035
Iteration: 19900 Loss: -6.803631782531738
</pre></div>
</div>
</div>
</div>
<p>The result, is essentially the same as before.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_iter</span><span class="p">),</span> <span class="n">elbos</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Iteration&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;ELBO&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/fb008fd9c6d7358cd2c729ab8d9dc707dcc68a6694067ff304e2fbeebc8882a2.svg" src="../_images/fb008fd9c6d7358cd2c729ab8d9dc707dcc68a6694067ff304e2fbeebc8882a2.svg" /></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">guide_g_samples</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Predictive</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">guide</span><span class="o">=</span><span class="n">guide</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1_000</span><span class="p">)(</span><span class="n">data</span><span class="p">)[</span><span class="s2">&quot;g&quot;</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="c1"># You have to detach the tensor from the computational graph</span>
<span class="c1"># otherwise it doesn&#39;t work.</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">guide_g_samples</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;VI Posterior&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">gpost</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True Posterior&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">g_true</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True value&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ef33e44dc9d592fb1e6eba002a4950dea7fe9186f0a9682d1202c0e4a2d59942.svg" src="../_images/ef33e44dc9d592fb1e6eba002a4950dea7fe9186f0a9682d1202c0e4a2d59942.svg" /></div>
</div>
</section>
<section id="example-2-coin-toss-example">
<h2>Example 2 - Coin-toss example<a class="headerlink" href="#example-2-coin-toss-example" title="Permalink to this heading">#</a></h2>
<p>Just like in the MCMC lecture, let’s look at the process of setting up a model and performing variational inference and diagnostics with the coin toss example.</p>
<p>The probabilistic model is as follows. We observe binary coin toss data:</p>
<div class="math notranslate nohighlight">
\[
x_i|\theta \sim \text{Bernoulli}(\theta),
\]</div>
<p>for <span class="math notranslate nohighlight">\(i=1, \dots, n\)</span>.</p>
<p>The prior over the latent variable <span class="math notranslate nohighlight">\(\theta\)</span> is a Beta distribution:</p>
<div class="math notranslate nohighlight">
\[
\theta \sim \text{Beta}(2, 2).
\]</div>
<p>We assign the prior as a Beta distribution with shape parameters 2 and 2, corresponding to a weak apriori belief that the coin is most likely fair.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thetaprior</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">beta</span><span class="p">(</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.999</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">thetaprior</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Prior&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/2ab1787854f2bdd4ee0ac28fa6564c0665c47e8d2725de24a02465c4110c8f59.svg" src="../_images/2ab1787854f2bdd4ee0ac28fa6564c0665c47e8d2725de24a02465c4110c8f59.svg" /></div>
</div>
<p>We wish to perform posterior inference on <span class="math notranslate nohighlight">\(\theta\)</span>:</p>
<div class="math notranslate nohighlight">
\[
p(\theta| x_{1:n}) \propto p(\theta) \prod_{i=1}^{n} p(x_i | \theta).
\]</div>
<p>Since this is a conjugate model, we know the posterior in closed form:</p>
<div class="math notranslate nohighlight">
\[
\theta | x_{1:n} \sim \text{Beta}\left(2+ \sum_{i=1}^n x_i, 2 + n - \sum_{i=1}^nx_i\right)
\]</div>
<p>Let’s generate some fake data and get the analytical posterior for comparison.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thetatrue</span> <span class="o">=</span><span class="mf">0.3</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">thetatrue</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">,)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">nheads</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">ntails</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="n">nheads</span>
<span class="n">theta_post</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">beta</span><span class="p">(</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">nheads</span><span class="p">,</span> <span class="mf">2.</span> <span class="o">+</span> <span class="n">ntails</span><span class="p">)</span>

<span class="c1"># plot data </span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="n">_</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">_</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">_</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Observed H/T frequencies&#39;</span><span class="p">)</span>

<span class="c1"># plot posterior</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.999</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">postpdf</span> <span class="o">=</span> <span class="n">theta_post</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">postpdf</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">postpdf</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Posterior&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">thetaprior</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prior&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">thetatrue</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True $</span><span class="se">\\</span><span class="s1">theta$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Coin Toss Bayesian Inference&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5f99d614869c22769b8197b826af7830a3d2ea6c0f5fea27938fd1d325b90273.svg" src="../_images/5f99d614869c22769b8197b826af7830a3d2ea6c0f5fea27938fd1d325b90273.svg" /></div>
</div>
<p>Let’s make the model in <code class="docutils literal notranslate"><span class="pre">pyro</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s2">&quot;theta&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Beta</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">pyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">pyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s1">&#39;obs&#39;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Bernoulli</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we need to make the guide.
We have many choices.
Let’s try a couple.
First, let’s just use a Gaussian.
We cannot use a Gaussian directly on <span class="math notranslate nohighlight">\(\theta\)</span> though because its support is <span class="math notranslate nohighlight">\([0, 1]\)</span>.
Instead, we put a Gaussian on a variable <span class="math notranslate nohighlight">\(z\)</span> with support <span class="math notranslate nohighlight">\(\mathbb{R}\)</span>:</p>
<div class="math notranslate nohighlight">
\[
z \sim N(\mu, \sigma^2).
\]</div>
<p>Then we transform <span class="math notranslate nohighlight">\(z\)</span> to <span class="math notranslate nohighlight">\(\theta\)</span> using the sigmoid function:</p>
<div class="math notranslate nohighlight">
\[
\theta = \frac{1}{1 + \exp(-z)}.
\]</div>
<p>Here is how we can do this in <code class="docutils literal notranslate"><span class="pre">pyro</span></code>.
We can either do it by hand:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyro.distributions</span> <span class="kn">import</span> <span class="n">constraints</span>
<span class="kn">from</span> <span class="nn">pyro.distributions</span> <span class="kn">import</span> <span class="n">transforms</span>

<span class="k">def</span> <span class="nf">gaussian_guide</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s1">&#39;mu&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mf">.1</span><span class="p">),</span> <span class="n">constraint</span><span class="o">=</span><span class="n">constraints</span><span class="o">.</span><span class="n">positive</span><span class="p">)</span>
    <span class="n">pyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="s2">&quot;theta&quot;</span><span class="p">,</span>
        <span class="n">dist</span><span class="o">.</span><span class="n">TransformedDistribution</span><span class="p">(</span>
            <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">SigmoidTransform</span><span class="p">()</span>
        <span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Or we can use the <code class="docutils literal notranslate"><span class="pre">AutoNormal</span></code> guide:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">auto_gaussian_guide</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">autoguide</span><span class="o">.</span><span class="n">AutoNormal</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>These are identical. Let’s just train the second one:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">elbos</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">auto_gaussian_guide</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">,),</span> <span class="n">num_iter</span><span class="o">=</span><span class="mi">20_000</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 0 Loss: 146.40711975097656
Iteration: 100 Loss: 141.49867248535156
Iteration: 200 Loss: 134.42784118652344
Iteration: 300 Loss: 129.84580993652344
Iteration: 400 Loss: 128.21202087402344
Iteration: 500 Loss: 130.95372009277344
Iteration: 600 Loss: 129.74700927734375
Iteration: 700 Loss: 128.5478515625
Iteration: 800 Loss: 122.86455535888672
Iteration: 900 Loss: 126.47606658935547
Iteration: 1000 Loss: 124.5881118774414
Iteration: 1100 Loss: 124.98439025878906
Iteration: 1200 Loss: 125.36991119384766
Iteration: 1300 Loss: 125.0341567993164
Iteration: 1400 Loss: 123.77005004882812
Iteration: 1500 Loss: 124.68547058105469
Iteration: 1600 Loss: 124.85704040527344
Iteration: 1700 Loss: 124.83834838867188
Iteration: 1800 Loss: 124.78903198242188
Iteration: 1900 Loss: 124.77840423583984
Iteration: 2000 Loss: 124.79694366455078
Iteration: 2100 Loss: 124.2547378540039
Iteration: 2200 Loss: 124.69900512695312
Iteration: 2300 Loss: 124.7703857421875
Iteration: 2400 Loss: 124.54391479492188
Iteration: 2500 Loss: 124.7482681274414
Iteration: 2600 Loss: 124.72441101074219
Iteration: 2700 Loss: 124.7225570678711
Iteration: 2800 Loss: 124.5625
Iteration: 2900 Loss: 124.7328109741211
Iteration: 3000 Loss: 124.63932037353516
Iteration: 3100 Loss: 124.71368408203125
Iteration: 3200 Loss: 124.7137680053711
Iteration: 3300 Loss: 124.69998168945312
Iteration: 3400 Loss: 124.72123718261719
Iteration: 3500 Loss: 124.69303131103516
Iteration: 3600 Loss: 124.7291259765625
Iteration: 3700 Loss: 124.6519775390625
Iteration: 3800 Loss: 124.72945404052734
Iteration: 3900 Loss: 124.67196655273438
Iteration: 4000 Loss: 124.6773910522461
Iteration: 4100 Loss: 124.67179870605469
Iteration: 4200 Loss: 124.59809875488281
Iteration: 4300 Loss: 124.79076385498047
Iteration: 4400 Loss: 124.67097473144531
Iteration: 4500 Loss: 124.6942138671875
Iteration: 4600 Loss: 124.68804168701172
Iteration: 4700 Loss: 124.74881744384766
Iteration: 4800 Loss: 124.62818908691406
Iteration: 4900 Loss: 124.75748443603516
Iteration: 5000 Loss: 124.6734390258789
Iteration: 5100 Loss: 124.70122528076172
Iteration: 5200 Loss: 124.689208984375
Iteration: 5300 Loss: 124.73365783691406
Iteration: 5400 Loss: 124.67781829833984
Iteration: 5500 Loss: 124.63542938232422
Iteration: 5600 Loss: 124.6197738647461
Iteration: 5700 Loss: 124.66807556152344
Iteration: 5800 Loss: 124.70440673828125
Iteration: 5900 Loss: 124.77986145019531
Iteration: 6000 Loss: 124.6969985961914
Iteration: 6100 Loss: 124.66635131835938
Iteration: 6200 Loss: 124.66107940673828
Iteration: 6300 Loss: 124.65746307373047
Iteration: 6400 Loss: 124.61973571777344
Iteration: 6500 Loss: 124.67634582519531
Iteration: 6600 Loss: 124.75775146484375
Iteration: 6700 Loss: 124.818115234375
Iteration: 6800 Loss: 124.67281341552734
Iteration: 6900 Loss: 124.69622039794922
Iteration: 7000 Loss: 124.6736831665039
Iteration: 7100 Loss: 124.70228576660156
Iteration: 7200 Loss: 124.62702941894531
Iteration: 7300 Loss: 124.63257598876953
Iteration: 7400 Loss: 124.68147277832031
Iteration: 7500 Loss: 124.73921203613281
Iteration: 7600 Loss: 124.63043212890625
Iteration: 7700 Loss: 124.66267395019531
Iteration: 7800 Loss: 124.7544174194336
Iteration: 7900 Loss: 124.66488647460938
Iteration: 8000 Loss: 124.64690399169922
Iteration: 8100 Loss: 124.80863189697266
Iteration: 8200 Loss: 124.59138488769531
Iteration: 8300 Loss: 124.572998046875
Iteration: 8400 Loss: 124.65132141113281
Iteration: 8500 Loss: 124.72315979003906
Iteration: 8600 Loss: 124.62680053710938
Iteration: 8700 Loss: 124.70709228515625
Iteration: 8800 Loss: 124.59783935546875
Iteration: 8900 Loss: 124.52831268310547
Iteration: 9000 Loss: 124.68631744384766
Iteration: 9100 Loss: 124.63186645507812
Iteration: 9200 Loss: 124.74536895751953
Iteration: 9300 Loss: 124.70989227294922
Iteration: 9400 Loss: 124.61333465576172
Iteration: 9500 Loss: 124.81995391845703
Iteration: 9600 Loss: 124.8375244140625
Iteration: 9700 Loss: 124.60042572021484
Iteration: 9800 Loss: 124.78146362304688
Iteration: 9900 Loss: 124.74494934082031
Iteration: 10000 Loss: 124.73494720458984
Iteration: 10100 Loss: 124.68846130371094
Iteration: 10200 Loss: 124.67047119140625
Iteration: 10300 Loss: 124.60511779785156
Iteration: 10400 Loss: 124.61138153076172
Iteration: 10500 Loss: 124.61978912353516
Iteration: 10600 Loss: 124.62849426269531
Iteration: 10700 Loss: 124.71034240722656
Iteration: 10800 Loss: 124.76557159423828
Iteration: 10900 Loss: 124.65545654296875
Iteration: 11000 Loss: 124.73983001708984
Iteration: 11100 Loss: 124.66980743408203
Iteration: 11200 Loss: 124.72845458984375
Iteration: 11300 Loss: 124.65077209472656
Iteration: 11400 Loss: 124.68489074707031
Iteration: 11500 Loss: 124.71796417236328
Iteration: 11600 Loss: 124.6515884399414
Iteration: 11700 Loss: 124.70018768310547
Iteration: 11800 Loss: 124.8572769165039
Iteration: 11900 Loss: 124.78717041015625
Iteration: 12000 Loss: 124.71411895751953
Iteration: 12100 Loss: 124.67271423339844
Iteration: 12200 Loss: 124.47366333007812
Iteration: 12300 Loss: 124.68609619140625
Iteration: 12400 Loss: 124.72593688964844
Iteration: 12500 Loss: 124.66497039794922
Iteration: 12600 Loss: 124.69234466552734
Iteration: 12700 Loss: 124.6677017211914
Iteration: 12800 Loss: 124.67044830322266
Iteration: 12900 Loss: 124.65167999267578
Iteration: 13000 Loss: 124.66949462890625
Iteration: 13100 Loss: 124.60675811767578
Iteration: 13200 Loss: 124.75745391845703
Iteration: 13300 Loss: 124.63687896728516
Iteration: 13400 Loss: 124.67958068847656
Iteration: 13500 Loss: 124.68183898925781
Iteration: 13600 Loss: 124.70476531982422
Iteration: 13700 Loss: 124.62003326416016
Iteration: 13800 Loss: 124.70536041259766
Iteration: 13900 Loss: 124.66747283935547
Iteration: 14000 Loss: 124.63028717041016
Iteration: 14100 Loss: 124.65388488769531
Iteration: 14200 Loss: 124.66047668457031
Iteration: 14300 Loss: 124.7000503540039
Iteration: 14400 Loss: 124.63937377929688
Iteration: 14500 Loss: 124.7081527709961
Iteration: 14600 Loss: 124.58367919921875
Iteration: 14700 Loss: 124.73462677001953
Iteration: 14800 Loss: 124.57368469238281
Iteration: 14900 Loss: 124.71100616455078
Iteration: 15000 Loss: 124.70767211914062
Iteration: 15100 Loss: 124.68736267089844
Iteration: 15200 Loss: 124.70284271240234
Iteration: 15300 Loss: 124.64090728759766
Iteration: 15400 Loss: 124.76419830322266
Iteration: 15500 Loss: 124.64111328125
Iteration: 15600 Loss: 124.69387817382812
Iteration: 15700 Loss: 124.68409729003906
Iteration: 15800 Loss: 124.6617660522461
Iteration: 15900 Loss: 124.68851470947266
Iteration: 16000 Loss: 124.71793365478516
Iteration: 16100 Loss: 124.70984649658203
Iteration: 16200 Loss: 124.69921112060547
Iteration: 16300 Loss: 124.51740264892578
Iteration: 16400 Loss: 124.77755737304688
Iteration: 16500 Loss: 124.66885375976562
Iteration: 16600 Loss: 124.71269989013672
Iteration: 16700 Loss: 124.70817565917969
Iteration: 16800 Loss: 124.25801086425781
Iteration: 16900 Loss: 124.83180236816406
Iteration: 17000 Loss: 124.67884063720703
Iteration: 17100 Loss: 124.67129516601562
Iteration: 17200 Loss: 124.70156860351562
Iteration: 17300 Loss: 124.67505645751953
Iteration: 17400 Loss: 124.71238708496094
Iteration: 17500 Loss: 124.7290267944336
Iteration: 17600 Loss: 124.76727294921875
Iteration: 17700 Loss: 124.67666625976562
Iteration: 17800 Loss: 124.63899993896484
Iteration: 17900 Loss: 124.52882385253906
Iteration: 18000 Loss: 124.59961700439453
Iteration: 18100 Loss: 124.64694213867188
Iteration: 18200 Loss: 124.68242645263672
Iteration: 18300 Loss: 124.67755126953125
Iteration: 18400 Loss: 124.6822280883789
Iteration: 18500 Loss: 124.6970443725586
Iteration: 18600 Loss: 124.69671630859375
Iteration: 18700 Loss: 124.67792510986328
Iteration: 18800 Loss: 124.6851577758789
Iteration: 18900 Loss: 124.79765319824219
Iteration: 19000 Loss: 124.63285064697266
Iteration: 19100 Loss: 124.67835235595703
Iteration: 19200 Loss: 124.69660186767578
Iteration: 19300 Loss: 124.70985412597656
Iteration: 19400 Loss: 124.7074966430664
Iteration: 19500 Loss: 124.78852081298828
Iteration: 19600 Loss: 124.65253448486328
Iteration: 19700 Loss: 124.67334747314453
Iteration: 19800 Loss: 124.64019775390625
Iteration: 19900 Loss: 124.61317443847656
</pre></div>
</div>
</div>
</div>
<p>The evolution of the ELBO:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">elbos</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Iteration&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;ELBO&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;ELBO vs SGD Iterations&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/7115a43faee1ada5afa5caeba6e79ccabc1c96e405e55915dbc77ffe94fb6153.svg" src="../_images/7115a43faee1ada5afa5caeba6e79ccabc1c96e405e55915dbc77ffe94fb6153.svg" /></div>
</div>
<p>Here is the posterior:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">thetas</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Predictive</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">guide</span><span class="o">=</span><span class="n">auto_gaussian_guide</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1_000</span><span class="p">)(</span><span class="n">data</span><span class="p">)[</span><span class="s2">&quot;theta&quot;</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">thetas</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;VI Posterior (Gaussian)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">thetaprior</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Prior&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">theta_post</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True Posterior&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">thetatrue</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True $</span><span class="se">\\</span><span class="s1">theta$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">theta$&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Density&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Coin Toss Bayesian Inference&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ad31737493f5ac7e03caf761b97ded7cf238176c7d4610947a3f1a659e06a630.svg" src="../_images/ad31737493f5ac7e03caf761b97ded7cf238176c7d4610947a3f1a659e06a630.svg" /></div>
</div>
<p>Pretty good.</p>
</section>
<section id="example-3-challenger-space-shuttle-disaster">
<h2>Example 3 - Challenger Space Shuttle Disaster<a class="headerlink" href="#example-3-challenger-space-shuttle-disaster" title="Permalink to this heading">#</a></h2>
<p>Let’s revisit this example from the MCMC lecture.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/PredictiveScienceLab/data-analytics-se/raw/master/lecturebook/data/challenger_data.csv&quot;</span>
<span class="n">download</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load data </span>
<span class="n">challenger_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="s2">&quot;challenger_data.csv&quot;</span><span class="p">,</span> <span class="n">skip_header</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">missing_values</span><span class="o">=</span><span class="s2">&quot;NA&quot;</span><span class="p">,</span>
                                <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
<span class="n">challenger_data</span> <span class="o">=</span> <span class="n">challenger_data</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">challenger_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Temp (F), O-Ring failure?&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">challenger_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Temp (F), O-Ring failure?
[[66.  0.]
 [70.  1.]
 [69.  0.]
 [68.  0.]
 [67.  0.]
 [72.  0.]
 [73.  0.]
 [70.  0.]
 [57.  1.]
 [63.  1.]
 [70.  1.]
 [78.  0.]
 [67.  0.]
 [53.  1.]
 [67.  0.]
 [75.  0.]
 [70.  0.]
 [81.  0.]
 [76.  0.]
 [79.  0.]
 [75.  1.]
 [76.  0.]
 [58.  1.]]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">challenger_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">challenger_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;ro&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Damage Incident?&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Outside temperature (Fahrenheit)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e720eea53b9cb1914b6d48ddce1aa9605f5d6f9f195ca8205640233ae70b1906.svg" src="../_images/e720eea53b9cb1914b6d48ddce1aa9605f5d6f9f195ca8205640233ae70b1906.svg" /></div>
</div>
<section id="probabilistic-model">
<h3>Probabilistic model<a class="headerlink" href="#probabilistic-model" title="Permalink to this heading">#</a></h3>
<p>The defect probability is modeled as a function of the outside temperature:</p>
<div class="math notranslate nohighlight">
\[
\sigma(t;\alpha,\beta) = \frac{1}{ 1 + e^{ \;\beta t + \alpha } }.
\]</div>
<p>The goal is to infer the latent variables <span class="math notranslate nohighlight">\(\alpha\)</span> and <span class="math notranslate nohighlight">\(\beta\)</span>.</p>
<p>We set normal priors on the latent variables:</p>
<div class="math notranslate nohighlight">
\[
\alpha \sim N(0, 10^2),
\]</div>
<p>and</p>
<div class="math notranslate nohighlight">
\[
\beta \sim N(0, 10^2),
\]</div>
<p>and the likelihood model is given by:</p>
<div class="math notranslate nohighlight">
\[
p(x_i | \alpha, \beta, t) = \text{Bernoulli}(x_i | \sigma(t; \alpha, \beta) ).
\]</div>
<p>Here is the model in <code class="docutils literal notranslate"><span class="pre">pyro</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">challenger_data</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">challenger_data</span><span class="p">)</span>
<span class="n">temperature</span> <span class="o">=</span> <span class="n">challenger_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">defect</span> <span class="o">=</span> <span class="n">challenger_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">defect</span><span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">100.</span><span class="p">))</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">100.</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">pyro</span><span class="o">.</span><span class="n">plate</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">temperature</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s1">&#39;logits&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">temperature</span><span class="p">)</span>
        <span class="n">pyro</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s1">&#39;obs&#39;</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">Bernoulli</span><span class="p">(</span><span class="n">logits</span><span class="o">=</span><span class="n">logits</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">defect</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We will use the <code class="docutils literal notranslate"><span class="pre">AutoNormal</span></code> guide:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">guide</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">autoguide</span><span class="o">.</span><span class="n">AutoDiagonalNormal</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

<span class="n">elbos</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">guide</span><span class="p">,</span> <span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">defect</span><span class="p">),</span> <span class="n">num_iter</span><span class="o">=</span><span class="mi">40_000</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Iteration: 0 Loss: 5531.840440750122
Iteration: 100 Loss: 5467.439811468124
Iteration: 200 Loss: 5410.4613201618195
Iteration: 300 Loss: 5439.929831027985
Iteration: 400 Loss: 5344.992549419403
Iteration: 500 Loss: 5336.480083465576
Iteration: 600 Loss: 5237.499451160431
Iteration: 700 Loss: 5137.388278126717
Iteration: 800 Loss: 5212.8310779333115
Iteration: 900 Loss: 5149.711973071098
Iteration: 1000 Loss: 5135.877537846565
Iteration: 1100 Loss: 5152.2343854904175
Iteration: 1200 Loss: 4916.988680720329
Iteration: 1300 Loss: 4904.5195878744125
Iteration: 1400 Loss: 4859.160486340523
Iteration: 1500 Loss: 4790.789856433868
Iteration: 1600 Loss: 4793.873239278793
Iteration: 1700 Loss: 4716.390684723854
Iteration: 1800 Loss: 4715.97630906105
Iteration: 1900 Loss: 4699.5179080963135
Iteration: 2000 Loss: 4561.090007901192
Iteration: 2100 Loss: 4613.398386597633
Iteration: 2200 Loss: 4485.692254781723
Iteration: 2300 Loss: 4550.878390073776
Iteration: 2400 Loss: 4473.403885304928
Iteration: 2500 Loss: 4429.689296364784
Iteration: 2600 Loss: 4329.89715385437
Iteration: 2700 Loss: 4292.824923992157
Iteration: 2800 Loss: 4254.371640324593
Iteration: 2900 Loss: 4187.539891242981
Iteration: 3000 Loss: 4122.154160141945
Iteration: 3100 Loss: 4129.982268214226
Iteration: 3200 Loss: 4145.018218278885
Iteration: 3300 Loss: 4029.89741563797
Iteration: 3400 Loss: 3999.8724485635757
Iteration: 3500 Loss: 3987.2998255491257
Iteration: 3600 Loss: 3925.0976563692093
Iteration: 3700 Loss: 3825.536500453949
Iteration: 3800 Loss: 3795.5549738407135
Iteration: 3900 Loss: 3741.4490801095963
Iteration: 4000 Loss: 3689.951833844185
Iteration: 4100 Loss: 3666.78730905056
Iteration: 4200 Loss: 3522.1737109422684
Iteration: 4300 Loss: 3558.4692071676254
Iteration: 4400 Loss: 3436.4042862653732
Iteration: 4500 Loss: 3473.5815712213516
Iteration: 4600 Loss: 3347.4105162620544
Iteration: 4700 Loss: 3312.775734066963
Iteration: 4800 Loss: 3326.7731975317
Iteration: 4900 Loss: 3255.529089808464
Iteration: 5000 Loss: 3244.5093750953674
Iteration: 5100 Loss: 3099.211985349655
Iteration: 5200 Loss: 3126.5875456929207
Iteration: 5300 Loss: 3212.296360850334
Iteration: 5400 Loss: 3104.723169028759
Iteration: 5500 Loss: 2971.083088517189
Iteration: 5600 Loss: 2919.641637444496
Iteration: 5700 Loss: 2984.3093383312225
Iteration: 5800 Loss: 2986.3900289535522
Iteration: 5900 Loss: 2907.4370554089546
Iteration: 6000 Loss: 2736.9824554920197
Iteration: 6100 Loss: 2755.4019446372986
Iteration: 6200 Loss: 2645.9654043912888
Iteration: 6300 Loss: 2659.0154242515564
Iteration: 6400 Loss: 2601.622731566429
Iteration: 6500 Loss: 2560.792522072792
Iteration: 6600 Loss: 2546.4471768140793
Iteration: 6700 Loss: 2459.5261366963387
Iteration: 6800 Loss: 2483.570861876011
Iteration: 6900 Loss: 2442.6171367764473
Iteration: 7000 Loss: 2415.6285407543182
Iteration: 7100 Loss: 2333.2669653892517
Iteration: 7200 Loss: 2314.1345807909966
Iteration: 7300 Loss: 2233.409161865711
Iteration: 7400 Loss: 2108.001457452774
Iteration: 7500 Loss: 2091.66572278738
Iteration: 7600 Loss: 2147.742255270481
Iteration: 7700 Loss: 1986.1463367938995
Iteration: 7800 Loss: 2074.554480791092
Iteration: 7900 Loss: 1988.131707072258
Iteration: 8000 Loss: 1856.3882100582123
Iteration: 8100 Loss: 1912.0738167762756
Iteration: 8200 Loss: 1778.7179647684097
Iteration: 8300 Loss: 1725.1792503595352
Iteration: 8400 Loss: 1720.107176065445
Iteration: 8500 Loss: 1602.0498898029327
Iteration: 8600 Loss: 1603.1558706760406
Iteration: 8700 Loss: 1556.1041314601898
Iteration: 8800 Loss: 1492.0800383090973
Iteration: 8900 Loss: 1543.2749433517456
Iteration: 9000 Loss: 1486.2857413291931
Iteration: 9100 Loss: 1415.5964547395706
Iteration: 9200 Loss: 1400.3231258392334
Iteration: 9300 Loss: 1257.0089687108994
Iteration: 9400 Loss: 1329.7085238695145
Iteration: 9500 Loss: 1251.2551156282425
Iteration: 9600 Loss: 1277.0183324813843
Iteration: 9700 Loss: 1234.7495634555817
Iteration: 9800 Loss: 1147.988602757454
Iteration: 9900 Loss: 1057.0762363672256
Iteration: 10000 Loss: 1031.7693130970001
Iteration: 10100 Loss: 892.5639562606812
Iteration: 10200 Loss: 909.6632229089737
Iteration: 10300 Loss: 877.7933025360107
Iteration: 10400 Loss: 753.6981749534607
Iteration: 10500 Loss: 715.0268689393997
Iteration: 10600 Loss: 721.5288599729538
Iteration: 10700 Loss: 693.9215047359467
Iteration: 10800 Loss: 730.3371777534485
Iteration: 10900 Loss: 607.5542094707489
Iteration: 11000 Loss: 479.1928918361664
Iteration: 11100 Loss: 477.115443110466
Iteration: 11200 Loss: 438.5263637304306
Iteration: 11300 Loss: 387.6681262254715
Iteration: 11400 Loss: 397.86532521247864
Iteration: 11500 Loss: 357.18476259708405
Iteration: 11600 Loss: 257.59286415577355
Iteration: 11700 Loss: 203.42165434589057
Iteration: 11800 Loss: 252.13669669628655
Iteration: 11900 Loss: 155.4922615321634
Iteration: 12000 Loss: 108.06966466168193
Iteration: 12100 Loss: 120.54031702338864
Iteration: 12200 Loss: 28.131296986370266
Iteration: 12300 Loss: 48.86347971390331
Iteration: 12400 Loss: 81.91930581011749
Iteration: 12500 Loss: 34.40188861010839
Iteration: 12600 Loss: 50.633073009812
Iteration: 12700 Loss: 46.92756452962382
Iteration: 12800 Loss: 37.385267973718896
Iteration: 12900 Loss: 42.964566793642724
Iteration: 13000 Loss: 49.122924703198976
Iteration: 13100 Loss: 28.693002473911697
Iteration: 13200 Loss: 21.94563579882517
Iteration: 13300 Loss: 24.6155895023483
Iteration: 13400 Loss: 53.0983372642654
Iteration: 13500 Loss: 45.253892200357114
Iteration: 13600 Loss: 31.90642666580855
Iteration: 13700 Loss: 22.36246727093565
Iteration: 13800 Loss: 64.1029375010568
Iteration: 13900 Loss: 38.094568499962506
Iteration: 14000 Loss: 32.348311205312584
Iteration: 14100 Loss: 33.94302588581073
Iteration: 14200 Loss: 41.013375893873125
Iteration: 14300 Loss: 46.296571659837056
Iteration: 14400 Loss: 22.21393667483687
Iteration: 14500 Loss: 28.75701686681686
Iteration: 14600 Loss: 23.146422104396294
Iteration: 14700 Loss: 41.55522962110102
Iteration: 14800 Loss: 23.621197192003187
Iteration: 14900 Loss: 22.23556067286522
Iteration: 15000 Loss: 75.79573570577291
Iteration: 15100 Loss: 28.071933327482274
Iteration: 15200 Loss: 26.54055291123494
Iteration: 15300 Loss: 25.109224081943513
Iteration: 15400 Loss: 33.03099874210464
Iteration: 15500 Loss: 30.37252674959501
Iteration: 15600 Loss: 23.35132493350241
Iteration: 15700 Loss: 25.2834504006692
Iteration: 15800 Loss: 33.63218533849563
Iteration: 15900 Loss: 33.35619829171088
Iteration: 16000 Loss: 33.2399583875767
Iteration: 16100 Loss: 22.823433792856573
Iteration: 16200 Loss: 23.606800600222307
Iteration: 16300 Loss: 26.03480179996911
Iteration: 16400 Loss: 23.373104679618894
Iteration: 16500 Loss: 32.687484351071376
Iteration: 16600 Loss: 27.81495510019398
Iteration: 16700 Loss: 26.497814345600695
Iteration: 16800 Loss: 40.23385912496974
Iteration: 16900 Loss: 23.544696206629716
Iteration: 17000 Loss: 26.092794149913892
Iteration: 17100 Loss: 25.733030370726496
Iteration: 17200 Loss: 23.590334892826025
Iteration: 17300 Loss: 22.771762556847413
Iteration: 17400 Loss: 26.93055204228299
Iteration: 17500 Loss: 23.620860005580717
Iteration: 17600 Loss: 32.72158898102857
Iteration: 17700 Loss: 29.851976563585705
Iteration: 17800 Loss: 30.637191060142325
Iteration: 17900 Loss: 26.575991850100266
Iteration: 18000 Loss: 22.897891640719276
Iteration: 18100 Loss: 24.232797890467587
Iteration: 18200 Loss: 27.709378925535635
Iteration: 18300 Loss: 26.139397063040374
Iteration: 18400 Loss: 24.27635989949359
Iteration: 18500 Loss: 24.3850958452265
Iteration: 18600 Loss: 23.523260291355385
Iteration: 18700 Loss: 20.11709161262572
Iteration: 18800 Loss: 26.137081675258724
Iteration: 18900 Loss: 24.100693261496772
Iteration: 19000 Loss: 24.080908056868388
Iteration: 19100 Loss: 26.71790017765957
Iteration: 19200 Loss: 22.539628616002393
Iteration: 19300 Loss: 28.01652611476491
Iteration: 19400 Loss: 26.264811232480724
Iteration: 19500 Loss: 25.632215380126546
Iteration: 19600 Loss: 26.184025786404945
Iteration: 19700 Loss: 24.991171580304353
Iteration: 19800 Loss: 20.762267645382124
Iteration: 19900 Loss: 23.443045101904502
Iteration: 20000 Loss: 25.557818279907185
Iteration: 20100 Loss: 25.413245100376635
Iteration: 20200 Loss: 24.35236036325578
Iteration: 20300 Loss: 23.695267222021002
Iteration: 20400 Loss: 30.088536627596085
Iteration: 20500 Loss: 25.456576625732943
Iteration: 20600 Loss: 24.855850276203046
Iteration: 20700 Loss: 25.98218212723841
Iteration: 20800 Loss: 25.203806922643402
Iteration: 20900 Loss: 23.739397518029477
Iteration: 21000 Loss: 24.998446105565144
Iteration: 21100 Loss: 26.125275932352075
Iteration: 21200 Loss: 25.284852833565587
Iteration: 21300 Loss: 23.335551004859354
Iteration: 21400 Loss: 24.780393375426073
Iteration: 21500 Loss: 23.53304818189704
Iteration: 21600 Loss: 24.30075760145206
Iteration: 21700 Loss: 25.873531213493262
Iteration: 21800 Loss: 24.763838635407726
Iteration: 21900 Loss: 24.65449638854551
Iteration: 22000 Loss: 25.238088151636
Iteration: 22100 Loss: 25.184846087505
Iteration: 22200 Loss: 26.412554197003594
Iteration: 22300 Loss: 24.31290720351019
Iteration: 22400 Loss: 27.01054110364891
Iteration: 22500 Loss: 24.541662875075783
Iteration: 22600 Loss: 25.171726538521007
Iteration: 22700 Loss: 24.63645757150681
Iteration: 22800 Loss: 24.716924068539175
Iteration: 22900 Loss: 25.09385697342757
Iteration: 23000 Loss: 24.54968923651359
Iteration: 23100 Loss: 24.939830410122596
Iteration: 23200 Loss: 24.77008452932077
Iteration: 23300 Loss: 24.693774089049796
Iteration: 23400 Loss: 25.04027028670434
Iteration: 23500 Loss: 24.71046433660923
Iteration: 23600 Loss: 24.74220483982083
Iteration: 23700 Loss: 24.930580907278273
Iteration: 23800 Loss: 24.63441159764347
Iteration: 23900 Loss: 25.89271028425992
Iteration: 24000 Loss: 22.31327231766053
Iteration: 24100 Loss: 24.86475461533178
Iteration: 24200 Loss: 24.642195178416017
Iteration: 24300 Loss: 24.1808025435154
Iteration: 24400 Loss: 24.32992456372284
Iteration: 24500 Loss: 24.648959134876698
Iteration: 24600 Loss: 24.615056160032665
Iteration: 24700 Loss: 25.01263727221301
Iteration: 24800 Loss: 22.950913192952093
Iteration: 24900 Loss: 26.242057011479908
Iteration: 25000 Loss: 25.99351987860893
Iteration: 25100 Loss: 25.211691610602067
Iteration: 25200 Loss: 24.264029837725033
Iteration: 25300 Loss: 24.766253170246493
Iteration: 25400 Loss: 23.491357273749117
Iteration: 25500 Loss: 23.379243879204736
Iteration: 25600 Loss: 24.22769627558646
Iteration: 25700 Loss: 25.445399706624265
Iteration: 25800 Loss: 24.978734815570046
Iteration: 25900 Loss: 24.042654637850212
Iteration: 26000 Loss: 24.326386272259043
Iteration: 26100 Loss: 24.53441774696436
Iteration: 26200 Loss: 24.28823064848941
Iteration: 26300 Loss: 24.18363859979795
Iteration: 26400 Loss: 25.158189741818024
Iteration: 26500 Loss: 24.947390314835634
Iteration: 26600 Loss: 24.18184237198568
Iteration: 26700 Loss: 24.92485720576039
Iteration: 26800 Loss: 24.085106304787985
Iteration: 26900 Loss: 25.154899753953497
Iteration: 27000 Loss: 24.729930345436323
Iteration: 27100 Loss: 26.68456166479145
Iteration: 27200 Loss: 24.785857837192374
Iteration: 27300 Loss: 24.714093779444056
Iteration: 27400 Loss: 24.951900485138168
Iteration: 27500 Loss: 32.60548680519277
Iteration: 27600 Loss: 24.547519421970584
Iteration: 27700 Loss: 24.776071810375644
Iteration: 27800 Loss: 25.1776069486447
Iteration: 27900 Loss: 25.980662046562063
Iteration: 28000 Loss: 24.8114534916983
Iteration: 28100 Loss: 24.569198951483795
Iteration: 28200 Loss: 26.071178728460126
Iteration: 28300 Loss: 24.52668833912155
Iteration: 28400 Loss: 24.544690495539232
Iteration: 28500 Loss: 24.361628396894943
Iteration: 28600 Loss: 25.047156040604236
Iteration: 28700 Loss: 24.701738551817808
Iteration: 28800 Loss: 24.416437732109834
Iteration: 28900 Loss: 25.21581594681751
Iteration: 29000 Loss: 24.40752640350304
Iteration: 29100 Loss: 24.62851916030602
Iteration: 29200 Loss: 23.400316986498588
Iteration: 29300 Loss: 24.116426538859006
Iteration: 29400 Loss: 25.668033055956013
Iteration: 29500 Loss: 25.01011626478007
Iteration: 29600 Loss: 26.892617660074222
Iteration: 29700 Loss: 24.623005919196082
Iteration: 29800 Loss: 25.363858118834564
Iteration: 29900 Loss: 24.700079187379238
Iteration: 30000 Loss: 23.176525311038823
Iteration: 30100 Loss: 24.794078392183582
Iteration: 30200 Loss: 24.47935007929105
Iteration: 30300 Loss: 24.769586561049437
Iteration: 30400 Loss: 25.493242609219337
Iteration: 30500 Loss: 25.126654099587313
Iteration: 30600 Loss: 24.677962226451413
Iteration: 30700 Loss: 22.933394798496593
Iteration: 30800 Loss: 24.137780233145975
Iteration: 30900 Loss: 24.095835924508656
Iteration: 31000 Loss: 24.489420498804947
Iteration: 31100 Loss: 23.630513066941244
Iteration: 31200 Loss: 24.72929591966595
Iteration: 31300 Loss: 24.93994864282298
Iteration: 31400 Loss: 23.566433791228064
Iteration: 31500 Loss: 24.241119301102124
Iteration: 31600 Loss: 24.199153438155506
Iteration: 31700 Loss: 21.00680318833583
Iteration: 31800 Loss: 24.893609652941482
Iteration: 31900 Loss: 23.47715658267218
Iteration: 32000 Loss: 24.88978917170494
Iteration: 32100 Loss: 24.6301785334378
Iteration: 32200 Loss: 25.18476292518303
Iteration: 32300 Loss: 24.920443379892866
Iteration: 32400 Loss: 24.680385032943512
Iteration: 32500 Loss: 24.728282281483672
Iteration: 32600 Loss: 23.635705259289374
Iteration: 32700 Loss: 25.95586955837196
Iteration: 32800 Loss: 24.723580397017614
Iteration: 32900 Loss: 24.666875734401636
Iteration: 33000 Loss: 25.032087855050513
Iteration: 33100 Loss: 24.723617230234183
Iteration: 33200 Loss: 25.25495396426038
Iteration: 33300 Loss: 26.741601171418573
Iteration: 33400 Loss: 25.25516262143809
Iteration: 33500 Loss: 25.23764309868569
Iteration: 33600 Loss: 25.21635326284201
Iteration: 33700 Loss: 26.260585099524526
Iteration: 33800 Loss: 24.841972574427604
Iteration: 33900 Loss: 24.708010783228623
Iteration: 34000 Loss: 24.578025781224785
Iteration: 34100 Loss: 25.067507734425412
Iteration: 34200 Loss: 23.26360834401894
Iteration: 34300 Loss: 24.589993648834046
Iteration: 34400 Loss: 22.88195302138935
Iteration: 34500 Loss: 25.25582019984487
Iteration: 34600 Loss: 24.19041685155333
Iteration: 34700 Loss: 24.874783366052842
Iteration: 34800 Loss: 23.928824580766328
Iteration: 34900 Loss: 23.57181191540545
Iteration: 35000 Loss: 25.4204153442002
Iteration: 35100 Loss: 27.3725087588739
Iteration: 35200 Loss: 25.82517000924866
Iteration: 35300 Loss: 24.672316666841574
Iteration: 35400 Loss: 24.954654894457246
Iteration: 35500 Loss: 25.064021662474637
Iteration: 35600 Loss: 24.467243174303327
Iteration: 35700 Loss: 24.58402136130203
Iteration: 35800 Loss: 25.183380740669044
Iteration: 35900 Loss: 26.84162246961659
Iteration: 36000 Loss: 24.871028071220614
Iteration: 36100 Loss: 25.961890336413756
Iteration: 36200 Loss: 24.70609163104905
Iteration: 36300 Loss: 25.214652789167886
Iteration: 36400 Loss: 25.53647420010599
Iteration: 36500 Loss: 24.887390255542947
Iteration: 36600 Loss: 24.52048166771558
Iteration: 36700 Loss: 25.187576438120992
Iteration: 36800 Loss: 24.97245007480887
Iteration: 36900 Loss: 24.514226378996316
Iteration: 37000 Loss: 26.312269941474767
Iteration: 37100 Loss: 24.709581556815486
Iteration: 37200 Loss: 24.912317514930283
Iteration: 37300 Loss: 24.759607036111817
Iteration: 37400 Loss: 23.855255417048244
Iteration: 37500 Loss: 24.83772185189435
Iteration: 37600 Loss: 24.244234649730217
Iteration: 37700 Loss: 24.878440081829496
Iteration: 37800 Loss: 24.755173988172373
Iteration: 37900 Loss: 25.22221595510717
Iteration: 38000 Loss: 25.835765420953486
Iteration: 38100 Loss: 27.64800215890736
Iteration: 38200 Loss: 24.890146405070634
Iteration: 38300 Loss: 24.791493714645217
Iteration: 38400 Loss: 24.79983196491165
Iteration: 38500 Loss: 24.626213595485872
Iteration: 38600 Loss: 24.59559494682597
Iteration: 38700 Loss: 24.390439427679482
Iteration: 38800 Loss: 26.236338326435767
Iteration: 38900 Loss: 24.699624270748654
Iteration: 39000 Loss: 24.34034355986111
Iteration: 39100 Loss: 24.099570085433996
Iteration: 39200 Loss: 23.612481569072724
Iteration: 39300 Loss: 25.33456478873308
Iteration: 39400 Loss: 25.796397527083784
Iteration: 39500 Loss: 22.78682486263129
Iteration: 39600 Loss: 24.111162545394915
Iteration: 39700 Loss: 24.733798883841885
Iteration: 39800 Loss: 25.33748707753372
Iteration: 39900 Loss: 25.219414985062468
</pre></div>
</div>
</div>
</div>
<p>It is always a good idea to plot the ELBO:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">elbos</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Iteration&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;ELBO&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;ELBO vs SGD Iterations&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/49ba4d61db17a752bd5a5ae0ccaf5bf47e0ecf5475b01465d14dd5046fb73292.svg" src="../_images/49ba4d61db17a752bd5a5ae0ccaf5bf47e0ecf5475b01465d14dd5046fb73292.svg" /></div>
</div>
<p>Now let’s plot the posterior of the parameters:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">param_samples</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Predictive</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">guide</span><span class="o">=</span><span class="n">guide</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1_000</span><span class="p">)(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span>

<span class="n">alpha_samples</span> <span class="o">=</span> <span class="n">param_samples</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span>
<span class="n">beta_samples</span> <span class="o">=</span> <span class="n">param_samples</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">alpha_samples</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;VI Posterior ($</span><span class="se">\\</span><span class="s1">alpha$)&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">alpha$&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;VI Posterior Density&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">beta_samples</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;VI Posterior ($</span><span class="se">\\</span><span class="s1">beta$)&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">beta$&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;VI Posterior Density&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>

<span class="c1"># Scatter plot of the samples</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">alpha_samples</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">beta_samples</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">alpha$&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;$</span><span class="se">\\</span><span class="s1">beta$&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e15e81a6d3e158f0e817c34f43dd344d86e5c13e038f9e0a906b34be879a26ad.svg" src="../_images/e15e81a6d3e158f0e817c34f43dd344d86e5c13e038f9e0a906b34be879a26ad.svg" /><img alt="../_images/ffc4f517c4c4d928dc13788321a25ba9a6bf50fafab31d91b36c7f940e8477e8.svg" src="../_images/ffc4f517c4c4d928dc13788321a25ba9a6bf50fafab31d91b36c7f940e8477e8.svg" /><img alt="../_images/0a8e5b4e13ca1176c4d360074e673bcdff0e06cd5459da39d8b76f3add81f394.svg" src="../_images/0a8e5b4e13ca1176c4d360074e673bcdff0e06cd5459da39d8b76f3add81f394.svg" /></div>
</div>
<p>Now we would like to plot the posterior predictive distribution as a function of the temperature.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">predictive_model</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">defect</span><span class="p">):</span>
    <span class="c1"># Use the original model to define the variables</span>
    <span class="nb">vars</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">[</span><span class="s2">&quot;beta&quot;</span><span class="p">]</span>
    <span class="n">temps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">temperature</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">temperature</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">deterministic</span><span class="p">(</span><span class="s1">&#39;predictions&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">alpha</span> <span class="o">+</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">temps</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">param_samples</span> <span class="o">=</span> <span class="n">pyro</span><span class="o">.</span><span class="n">infer</span><span class="o">.</span><span class="n">Predictive</span><span class="p">(</span>
    <span class="n">predictive_model</span><span class="p">,</span>
    <span class="n">guide</span><span class="o">=</span><span class="n">guide</span><span class="p">,</span>
    <span class="n">num_samples</span><span class="o">=</span><span class="mi">1_000</span>
<span class="p">)(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">defect</span><span class="p">)</span>

<span class="n">temps</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">temperature</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">temperature</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">param_samples</span><span class="p">[</span><span class="s2">&quot;predictions&quot;</span><span class="p">]</span>
<span class="n">pred_500</span><span class="p">,</span> <span class="n">pred_025</span><span class="p">,</span> <span class="n">pred_975</span> <span class="o">=</span> <span class="n">predictions</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.975</span><span class="p">]),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">defect</span><span class="p">,</span> <span class="s1">&#39;ro&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temps</span><span class="p">,</span> <span class="n">pred_500</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="s1">&#39;b&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">temps</span><span class="p">,</span> <span class="n">pred_025</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">pred_975</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Damage Incident?&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Outside temperature (Fahrenheit)&quot;</span><span class="p">)</span>
<span class="c1"># Plot a few samples</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">temps</span><span class="p">,</span> <span class="n">predictions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">trim</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c30a518a72e6b135a7c66c17c9ef096d6f4326afa276a481addfa954e89a6ebb.svg" src="../_images/c30a518a72e6b135a7c66c17c9ef096d6f4326afa276a481addfa954e89a6ebb.svg" /></div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./lecture28"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="reading-28.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Variational Inference</p>
      </div>
    </a>
    <a class="right-next"
       href="../homework/intro.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Homework</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-1-normal-normal-model">Example 1 - normal-normal model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-2-coin-toss-example">Example 2 - Coin-toss example</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-3-challenger-space-shuttle-disaster">Example 3 - Challenger Space Shuttle Disaster</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#probabilistic-model">Probabilistic model</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Ilias Bilionis (ibilion[at]purdue.edu)
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=ac02cc09edc035673794"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>